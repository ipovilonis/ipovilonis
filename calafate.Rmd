---
title: "Análisis de componentes principales en Calafate
(_Berberis mycrophylla_)"

---

## Variables respuesta:

**TFS**: Total fruiting shoots per plant  
**FNP**: Fruit number per plant  
**FFWP**: Fresh fruit weight per plant  
**FFW**: Fresh fruit weight  
**DFW**: Dry fruit weight  
**EFD**: Equatorial fruit diameter  
**PFD**: Polar fruit diameter  
**FC**: Color del fruto
**FF**: Fruit firmness  
**NPR**: Tasa de fotosíntesis (irradiancia=500)


```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=10, fig.height=8}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

library(readxl)
calafate <- read_excel("database.xlsx", sheet = "calafate")

calafate$Season<-as.factor(calafate$Season)
calafate$Ligth<-as.factor(calafate$Ligth)
calafate$Fertilization<-as.factor(calafate$Fertilization)

```

```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=10, fig.height=8}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

# calafate$AÑO<-as.factor(calafate$AÑO)
# calafate$Ligth<-as.factor(calafate$Ligth)
# calafate$FERTI<-as.factor(calafate$FERTI)
# 
# library(dplyr)
# library(ggplot2)
# library(ggpubr)
# library(emmeans)
# library(multcompView)
# library(multcomp)
# library(car)
# 
# # Crea un vector con las variables respuesta
# variables_respuesta_calafate <- c("PF", "PFPRO")
# 
# # Inicializa listas para almacenar las tablas
# tablas_ER_calafate <- list()
# 
# for (variable in variables_respuesta_calafate) {
# 
#   if (!variable %in% colnames(calafate)) {
#     warning(paste("La variable", variable, "no se encuentra en el dataframe 'calafate'"))
#     next
#   }
# 
#   # Crea la tabla resumen
#   tabla_resumen <- calafate %>%
#     group_by(Season, Ligth, Fertilization) %>%
#     summarise(
#       n = n(),
#       Mean = mean(.data[[variable]], na.rm = TRUE),
#       sd = sd(.data[[variable]], na.rm = TRUE),
#       .groups = "drop_last"
#     )
# 
#   # Agrega la tabla a la lista
#   tablas_ER_calafate[[variable]] <- tabla_resumen
# 
# }
# 
# # Mostrar las tablas generadas
# tablas_ER_calafate


```

```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=10, fig.height=8}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

calafate2 <- calafate[,-c(1:3)]

# estandarizar

# Seleccionar las columnas numéricas
numeric_cols <- sapply(calafate2, is.numeric)

# Estandarizar las columnas numéricas
datos_estandarizados <- calafate2
datos_estandarizados[, numeric_cols] <- scale(calafate2[, numeric_cols])

```

```{r, echo=FALSE, error=TRUE, fig.align='center', fig.asp=0.4, fig.width=20, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE, out.width='95%')
# Cargar las librerías necesarias
# library(ggplot2)
# library(factoextra)
# 
# # Seleccionar solo las columnas numéricas
# numeric_cols <- sapply(datos_estandarizados, is.numeric)
# data_numeric <- datos_estandarizados[, numeric_cols]
# 
# # Asegurarse de que data_numeric sea un data.frame
# data_numeric <- as.data.frame(data_numeric)
# 
# # Manejar valores faltantes e infinitos
# # Reemplazar infinitos con NA
# data_numeric[do.call(cbind, lapply(data_numeric, is.infinite))] <- NA
# 
# # Imputar valores faltantes (NA) con la media de cada columna
# data_numeric <- as.data.frame(lapply(data_numeric, function(x) {
#   if(is.numeric(x)) {
#     return(ifelse(is.na(x), mean(x, na.rm = TRUE), x))
#   } else {
#     return(x)
#   }
# }))
# 
# # Verificar que no haya NA ni Inf
# any(is.na(data_numeric))      # Debería ser FALSE
# any(do.call(cbind, lapply(data_numeric, is.infinite)))  # Debería ser FALSE
# 
# # Realizar el PCA
# pca_result <- prcomp(data_numeric, center = TRUE, scale. = TRUE)
# 
# # Ver resumen del PCA
# # summary(pca_result)
# 
# # Ver los loadings (contribuciones de cada variable a los componentes principales)
# # print(pca_result$rotation)
# 
# # Ver los scores (valores de las muestras en los componentes principales)
# # head(pca_result$x)
# 
# # Visualización de los resultados
# 
# # Biplot de los dos primeros componentes principales
# biplot <- biplot(pca_result, scale = 0)
# 
# # Scree plot para ver la varianza explicada por cada Principal component
# fviz_eig(pca_result)
# 
# # Biplot variables
# biplot_variables <- fviz_pca_biplot(pca_result, repel = TRUE,
#                 col.var = "#2E9FDF", # color de las variables
#                 col.ind = "red")

```


```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=10, fig.height=8}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

# # Obtener las contribuciones de las variables a cada Principal component
# pca_var <- get_pca_var(pca_result)
# 
# # Ordenar las variables por contribución para Dim.1 (PC1)
# pca_var_dim1 <- pca_var$contrib[, 1] %>% sort(decreasing = TRUE)
# pca_var_dim1
# 
# # Ordenar las variables por contribución para Dim.2 (PC2)
# pca_var_dim2 <- pca_var$contrib[, 2] %>% sort(decreasing = TRUE)
# pca_var_dim2

```

```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=10, fig.height=8}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

# # Resultados originales de PCA para Dim.1
# pca_var_dim1 <- c(
#   NUPRORAFRU = 12.264316955, ES = 12.117800671, NUFRU = 10.955191997, DL = 9.865780920, 
#   PR = 9.532570716, PF = 9.210555035, RA = 6.971195771, BA = 5.851173698, 
#   PH = 5.724228415, DT = 4.928441229, PS = 4.173394893, COLOR.FR = 3.852417006, 
#   FIRMEZA = 3.676926256, PFPRO = 0.394914616, CO2 = 0.314126604, MATSEC = 0.166965218
# )
# 
# # Ordenar las variables por contribución para Dim.2 (PC2)
# pca_var_dim2 <- c(
#   PS = 20.1469037152, FIRMEZA = 16.9419708146, COLOR.FR = 14.7690179094, DT = 14.6021353923, 
#   PH = 9.7674390115, BA = 7.1636993739, CO2 = 5.0739096231, DL = 3.6895527210, 
#   PFPRO = 2.4514648733, MATSEC = 2.4238101927, RA = 1.7004703966, NUPRORAFRU = 0.8096899842, 
#   PR = 0.1626035852, NUFRU = 0.1585114789, ES = 0.0958781422, PF = 0.0429427859
# )
# 
# # Asegurarse de que los nombres de las variables coincidan entre los dos vectores
# common_names <- intersect(names(pca_var_dim1), names(pca_var_dim2))
# 
# # Filtrar solo las variables comunes
# pca_var_dim1_filtered <- pca_var_dim1[common_names]
# pca_var_dim2_filtered <- pca_var_dim2[common_names]
# # Sumar las contribuciones de cada variable en los dos componentes
# combined_contributions <- pca_var_dim1_filtered + pca_var_dim2_filtered
# 
# # Ordenar las variables por su contribución acumulada
# sorted_contributions <- sort(combined_contributions, decreasing = TRUE)
# 
# # Mostrar el resultado
# sorted_contributions

```

Resultado PCA
```{r, echo=FALSE, error=TRUE, fig.align='center', fig.asp=0.4, fig.width=10, fig.height=8}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

library(dplyr)
# Seleccionar las columnas específicas del dataframe
datos_filtrados <- datos_estandarizados %>%
  dplyr::select(EFD, PFD, FC, FF, FFW, DFW, TFS, FNP, FFWP, NPR)
  
# dplyr::select(TFS, FNP, FFWP, CO2)
# 
  # dplyr::select(PS, FIRMEZA, DT, PH, CO2, DL, NUPRORAFRU, NUFRU, PF)

# Realizar el PCA
pca_result <- prcomp(datos_filtrados, center = TRUE, scale. = TRUE)


pca_scores <- as.data.frame(pca_result$x[,c(1:3)])
pca_scores$Season <- calafate$Season
pca_scores$Ligth <- calafate$Ligth
pca_scores$Fertilization <- calafate$Fertilization

# Ver resumen del PCA
summary(pca_result)

# Ver los loadings (contribuciones de cada variable a los componentes principales)
# print(pca_result$rotation)

# Ver los scores (valores de las muestras en los componentes principales)
# head(pca_result$x)

# Visualización de los resultados

# Biplot de los dos primeros componentes principales
# biplot <- biplot(pca_result, scale = 0)

# Biplot variables
# biplot_variables <- fviz_pca_biplot(pca_result, repel = TRUE,
#                 col.var = "#2E9FDF", # color de las variables
#                 col.ind = "red")

```

Heatmap
```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=10, fig.height=8}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)


library(ggplot2)
library(dplyr)
library(reshape2)
library(data.table)

# Supongamos que 'data' es tu dataframe con solo variables numéricas
calculate_p_values <- function(data) {
  num_vars <- names(data)
  p_matrix <- matrix(NA, nrow = length(num_vars), ncol = length(num_vars))
  
  for (i in 1:length(num_vars)) {
    for (j in 1:length(num_vars)) {
      if (i != j) {
        test <- cor.test(data[[num_vars[i]]], data[[num_vars[j]]], method = "pearson")
        p_matrix[i, j] <- test$p.value
      } else {
        p_matrix[i, j] <- NA
      }
    }
  }
  
  rownames(p_matrix) <- colnames(p_matrix) <- num_vars
  return(p_matrix)
}

# Convertir 'calafate' a data.table y seleccionar solo las variables numéricas
dt <- as.data.table(datos_filtrados)
num_vars <- dt[, .SD, .SDcols = is.numeric]

# Calcular la matriz de p-valores
p_matrix <- calculate_p_values(num_vars)

# Convertir la matriz de p-valores a formato largo
p_long <- melt(p_matrix, varnames = c("Variable1", "Variable2"), value.name = "PValue")

# Añadir los símbolos de significancia
p_long$Significance <- cut(p_long$PValue, 
                            breaks = c(-Inf, 0.001, 0.01, 0.05, Inf), 
                            labels = c("***", "**", "*", ""))

# Calcular la matriz de correlación
cor_matrix <- cor(num_vars)

# Transforma la matriz de correlación a formato largo
cor_long <- melt(cor_matrix, varnames = c("Variable1", "Variable2"), value.name = "Correlation")

# Convertir Variable1 y Variable2 a caracteres
cor_long <- cor_long %>%
  dplyr::mutate(Variable1 = as.character(Variable1),
                Variable2 = as.character(Variable2))

# Filtrar para mantener solo la mitad inferior de la matriz y la diagonal
cor_long <- cor_long %>%
  dplyr::filter(Variable1 <= Variable2)

# Combinar con la matriz de p-valores
cor_long <- merge(cor_long, p_long[, c("Variable1", "Variable2", "Significance")], 
                   by = c("Variable1", "Variable2"))

# Crear el heatmap
heatmap <- ggplot(cor_long, aes(x = Variable1, y = Variable2, fill = Correlation)) +
  geom_tile() +
  scale_fill_gradient2(
    low = "red", 
    mid = "white", 
    high = "blue", 
    midpoint = 0,
    guide = guide_colorbar(
      title = "Correlation", 
      barheight = unit(1, "lines"),  
      barwidth = unit(40, "lines"),
      size=24
    )
  ) +
  geom_tile(data = cor_long %>% dplyr::filter(Variable1 == Variable2), 
            fill = "white", color = "white") +  # Cambia el color de la diagonal a blanco
  geom_text(aes(label = Significance), color = "black", size = 18) +  # Añadir significancia
  theme_minimal() +
  labs(x = "", y = "", fill = "Correlation") +
  theme(
    axis.text.x = element_blank(),  # Eliminar nombres de variables del eje x
    axis.text.y = element_blank(),  # Eliminar nombres de variables del eje y
    plot.title = element_text(hjust = 0.5, size = rel(1), color = "black"),
    legend.position = 'bottom',
    panel.grid.major = element_blank(),  # Eliminar las líneas de la cuadrícula
    text = element_text(size = 20, color = 'black'),
    axis.ticks = element_blank()  # Eliminar las marcas en los ejes
  ) +
  coord_fixed()  # Mantener la proporción de aspecto

# Añadir nombres de variables en la diagonal central
heatmap <- heatmap +
  geom_text(
    data = cor_long %>% dplyr::filter(Variable1 == Variable2), 
    aes(label = Variable1), 
    color = "black", 
    size = 10, 
    vjust = 0.5, 
    hjust = 0.5
  )

# Mostrar el gráfico
print(heatmap)



```

Scree plot para ver la varianza explicada por cada Principal component
```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=24, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

library(factoextra)
library(ggplot2)
library(ggrepel)

eig_values <- pca_result$sdev^2 / sum(pca_result$sdev^2) * 100  # Calcular % de varianza explicada
eig_values <- round(eig_values, 2)  # Redondear a dos decimales

# Crear el gráfico de barras con etiquetas ajustadas
gg_scree <- fviz_eig(pca_result, addlabels = FALSE) +
  geom_bar(stat = "identity", aes(y = eig_values, x = factor(1:length(eig_values))), fill = "#FB9A99") +
  geom_text(aes(label = eig_values, y = eig_values, x = factor(1:length(eig_values)), vjust = -0.5), size = 12) +
  theme_classic() +
  labs(title = "",
       x = "Principal component",
       y = "Percentage of variance [%]") +
  theme(text = element_text(size = 32, color = 'black'),
        axis.text = element_text(size = 32, color = 'black'),
        legend.position = "none")
gg_scree

```

Contribuciones de las variables para CP1
```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=24, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

# Obtener las contribuciones de las variables a cada Principal component
pca_var <- get_pca_var(pca_result)

```

Contribuciones de las variables para CP2
```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=10, fig.height=8}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

# Ordenar las variables por contribución para Dim.1 (PC1)
pca_var_dim1 <- pca_var$contrib[, 1] %>% sort(decreasing = TRUE)
pca_var_dim1

# Ordenar las variables por contribución para Dim.2 (PC2)
pca_var_dim2 <- pca_var$contrib[, 2] %>% sort(decreasing = TRUE)
pca_var_dim2

# Ordenar las variables por contribución para Dim.3 (PC3)
pca_var_dim3 <- pca_var$contrib[, 3] %>% sort(decreasing = TRUE)
pca_var_dim3

```

Contribución acumulada de cada variable a CP1 y CP2
```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=10, fig.height=8}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

# Asegurarse de que los nombres de las variables coincidan entre los dos vectores
common_names <- intersect(names(pca_var_dim1), names(pca_var_dim2))

# Filtrar solo las variables comunes
pca_var_dim1_filtered <- pca_var_dim1[common_names]
pca_var_dim2_filtered <- pca_var_dim2[common_names]
# Sumar las contribuciones de cada variable en los dos componentes
combined_contributions <- pca_var_dim1_filtered + pca_var_dim2_filtered

# Ordenar las variables por su contribución acumulada
sorted_contributions <- sort(combined_contributions, decreasing = TRUE)

# Mostrar el resultado
sorted_contributions

```

Proporción de contribución de cada variable a PC1, PC2 y PC3
```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=24, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
# Suponiendo que tienes el objeto pca_result con la salida de tu análisis PCA
library(ggplot2)
library(dplyr)
library(tidyr)

# Extraer las rotaciones (cargas) de los componentes principales
loadings <- as.data.frame(pca_result$rotation)

# Seleccionar solo las cargas para PC1, PC2 y PC3
loadings <- loadings %>%
  dplyr::select(PC1, PC2, PC3)

# Calcular la proporción de contribución para cada parámetro en cada componente
loadings <- loadings %>%
  dplyr::mutate(Variable = rownames(loadings),
         PC1 = abs(PC1) / sum(abs(PC1)),
         PC2 = abs(PC2) / sum(abs(PC2)),
         PC3 = abs(PC3) / sum(abs(PC3)))

# Convertir los datos a formato largo (long format)
loadings_long <- loadings %>%
  pivot_longer(cols = starts_with("PC"),
               names_to = "Component",
               values_to = "Contribution")

library(RColorBrewer)
# "Set1", "Set2", "Set3", "Pastel1", "Pastel2", "Paired", "Dark2", "Accent"

# Crear el gráfico de barras apiladas
gg_bar_agr <- ggplot(loadings_long, aes(x = Component, y = Contribution * 100, fill = Variable)) +
  geom_bar(stat = "identity", size = 5) +
  geom_text(aes(label = paste0(round(Contribution * 100, 1), "%")), 
            position = position_stack(vjust = 0.5), 
            size = 6, color = "black") +
  scale_fill_brewer(palette = "Paired") +
  labs(title = "",
       x = "Principal component",
       y = "Percentage of coefficients") +
  theme_classic() +
  theme(text = element_text(size = 32, color = 'black'),
        legend.position = "right",
        legend.title = element_blank()) +
  theme(axis.text = element_text(color = 'black')) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) # Cambiar las etiquetas del eje y a porcentaje


gg_bar_agr

```

## Biplots de PCA CP1 VS CP2
```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=24, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

# c("#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99",
# "#E31A1C", "#FDBF6F", "#FF7F00", "#CAB2D6", "#6A3D9A",
# "#FFFF00", "#B15928")

biplot_variables <- fviz_pca_biplot(pca_result, 
                        axes = c(1, 2), # Especifica CP1 y CP2
                        repel = TRUE,
                        col.var = "black", # Color de las variables
                        geom.ind = "point",
                        label = "var", # Etiquetas solo para las variables
                        addEllipses = FALSE,
                        labelsize = 6) +
  geom_point(data = pca_scores, 
             aes(x = PC1, y = PC2, color = Fertilization), size = 10) + 
  scale_color_manual(values = c("0" = "#E31A1C", "1" = "#FDBF6F", "2" = "#B2DF8A")) +
  theme_classic() +
  labs(title = "", x = "", y = "PC 2 (26,51 %)") +
  theme(legend.position = "none",
        text = element_text(size = 26, color = 'black'),
        axis.text = element_text(color = 'black')) +
  geom_text(aes(x = Inf, y = Inf, label = "A"), 
            hjust = 1.2, vjust = 1.2, size = 13, color = "black", fontface = "bold")


```

```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=24, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

biplot_variables_2 <- fviz_pca_biplot(pca_result, 
  axes = c(1, 2), # Aquí especificamos que queremos CP1 y CP2
  repel = TRUE,
  col.var = "black", # color de las variables
  geom.ind = "point",
  label = "var", # para que solo las variables tengan etiquetas
  addEllipses = FALSE,
  labelsize = 6) +
  # geom_text_repel(data = pca_scores, aes(x = PC1, y = PC2, label = Season), size = 10, box.padding = 0.5)+ 
  geom_point(data = pca_scores, 
             aes(x = PC1, y = PC2, color = Ligth), size = 10) +
  scale_color_manual(values = c("High" = "#FFFF00", "Medium" = "#4C4C4C")) +
   theme_classic() +
  labs(title = "", x = "", y = "") + #Principal component 2 (26,51 %)
  theme(legend.position = "none")+
  theme(text = element_text(size=26, color='black'))+
  theme(axis.text = element_text(color='black'))+
  geom_text(aes(x = Inf, y = Inf, label = "B"), 
            hjust = 1.2, vjust = 1.2, size = 13, color = "black", fontface = "bold")
# biplot_variables_2

# biplot_variables_2 <- fviz_pca_biplot(pca_result, repel = TRUE,
#                                     col.var = "black", # color de las variables
#                                     geom.ind = "point",
#                                     label = "var", # para que solo las variables tengan etiquetas
#                                     addEllipses = FALSE) +
#   geom_text_repel(data = pca_scores, aes(x = PC1, y = PC2, label = Season), size = 10, box.padding = 0.5)+ 
#   geom_point(data = pca_scores, 
#              aes(x = PC1, y = PC2, color = Ligth, shape = Fertilization), size = 10) +
#   scale_color_manual(values = c("High" = "#FFFF00", "Medium" = "#A6CEE3")) +
#    theme_classic() +
#   labs(title = "", x = "Principal component 1 (51,85 %)", y = "Principal component 2 (26,51 %)") +
#   theme(legend.position = "bottom")+
#   theme(text = element_text(size=26, color='black'))+
#   theme(axis.text = element_text(color='black'))
# biplot_variables_2

```

```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=24, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

biplot_variables_3 <- fviz_pca_biplot(pca_result, 
  axes = c(1, 2), # Aquí especificamos que queremos CP1 y CP3
  repel = TRUE,
  col.var = "black", # color de las variables
  geom.ind = "point",
  label = "var", # para que solo las variables tengan etiquetas
  addEllipses = FALSE,
  labelsize = 6) +
  # geom_text_repel(data = pca_scores, aes(x = PC1, y = PC2, label = Ligth), size = 10, box.padding = 0.5)+ 
  geom_point(data = pca_scores, 
             aes(x = PC1, y = PC2, color = Season), size = 10) +
  scale_color_manual(values = c("1st" = "#6A3D9A", "2nd" = "#FF7F00")) +
   theme_classic() +
  labs(title = "", x = "", y = "") +
  theme(legend.position = "none")+
  theme(text = element_text(size=26, color='black'))+
  theme(axis.text = element_text(color='black'))+
  geom_text(aes(x = Inf, y = Inf, label = "C"), 
            hjust = 1.2, vjust = 1.2, size = 13, color = "black", fontface = "bold")
# biplot_variables_3

```


## Biplots de PCA CP1 VS CP3
```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=24, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

# c("#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99",
# "#E31A1C", "#FDBF6F", "#FF7F00", "#CAB2D6", "#6A3D9A",
# "#FFFF00", "#B15928")

biplot_variables_cp3 <- fviz_pca_biplot(pca_result,
                                    repel = TRUE,
                                    axes = c(1, 3),
                                    col.var = "black", # color de las variables
                                    geom.ind = "point",
                                    label = "var", # para que solo las variables tengan etiquetas
                                    addEllipses = FALSE,
                                    labelsize = 6) +
  # geom_text_repel(data = pca_scores, aes(x = PC1, y = PC3, label = Season), size = 10, box.padding = 0.5) +
  geom_point(data = pca_scores, 
             aes(x = PC1, y = PC3, color = Fertilization), size = 10) +
  scale_color_manual(values = c("0" = "#E31A1C", "1" = "#FDBF6F", "2" = "#B2DF8A")) +
    theme_classic() +
  labs(title = "", x = "", y = "PC 3 (11,72 %)") +
  theme(legend.position = "bottom") +
  theme(text = element_text(size = 26, color = 'black')) +
  theme(axis.text = element_text(color = 'black'))+
  geom_text(aes(x = Inf, y = Inf, label = "D"), 
            hjust = 1.2, vjust = 1.2, size = 13, color = "black", fontface = "bold")

# biplot_variables_cp3

```

```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=24, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

biplot_variables_2_cp3 <- fviz_pca_biplot(pca_result,
                                          axes = c(1, 3),
                                          repel = TRUE,
                                    col.var = "black", # color de las variables
                                    geom.ind = "point",
                                    label = "var", # para que solo las variables tengan etiquetas
                                    addEllipses = FALSE,
                                    labelsize = 6) +
  # geom_text_repel(data = pca_scores, aes(x = PC1, y = PC3, label = Season), size = 10, box.padding = 0.5)+ 
  geom_point(data = pca_scores, 
             aes(x = PC1, y = PC3, color = Ligth), size = 10) +
  scale_color_manual(values = c("High" = "#FFFF00", "Medium" = "#4C4C4C")) +
   theme_classic() +
  labs(title = "", x = "PC 1 (51,85 %)", y = "") +
  theme(legend.position = "bottom")+
  theme(text = element_text(size=26, color='black'))+
  theme(axis.text = element_text(color='black'))+
  geom_text(aes(x = Inf, y = Inf, label = "E"), 
            hjust = 1.2, vjust = 1.2, size = 13, color = "black", fontface = "bold")
# biplot_variables_2_cp3

```

```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=24, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

library(factoextra)
library(ggplot2)

# Crear el biplot asegurando el uso de CP1 y CP3
biplot_variables_3_cp3 <- fviz_pca_biplot(
  pca_result, 
  axes = c(1, 3), # Aquí especificamos que queremos CP1 y CP3
  repel = TRUE,
  col.var = "black", # color de las variables
  geom.ind = "point",
  label = "var", # para que solo las variables tengan etiquetas
  addEllipses = FALSE,
  labelsize = 6,
  arrow.size = 1 # Ajustar el tamaño de las flechas
) +
  # geom_text_repel(data = pca_scores, 
  #                 aes(x = PC1, y = PC3, label = Ligth), 
  #                 size = 10, 
  #                 box.padding = 0.5) + 
  geom_point(data = pca_scores, 
             aes(x = PC1, y = PC3, color = Season), 
             size = 10) +
  scale_color_manual(values = c("1st" = "#6A3D9A", "2nd" = "#FF7F00")) +
  theme_classic() +
  labs(title = "", 
       x = "", #Principal component 1 (51,85 %)
       y = "") + #Principal component 3 (11,72 %)
  theme(legend.position = "bottom") +
  theme(text = element_text(size=26, color='black')) +
  theme(axis.text = element_text(color='black'))+
  geom_text(aes(x = Inf, y = Inf, label = "F"), 
            hjust = 1.2, vjust = 1.2, size = 13, color = "black", fontface = "bold")

# Mostrar el gráfico
# biplot_variables_3_cp3

```

```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=24, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)



```

```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=24, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

library(ggpubr)

combined_plot <- ggarrange(biplot_variables, biplot_variables_2, biplot_variables_3,
                           biplot_variables_cp3, biplot_variables_2_cp3, biplot_variables_3_cp3,
                           ncol = 3, nrow = 2,
                           common.legend = F)
combined_plot
```

## Análisis univariado Tasa de fotosíntesis (**NPR**)
```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=10, fig.height=8}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

library(readxl)
calafate2 <- read_excel("database.xlsx", sheet = "calafate2")

calafate2$Season<-as.factor(calafate2$Season)
calafate2$Ligth<-as.factor(calafate2$Ligth)
calafate2$Fertilization<-as.factor(calafate2$Fertilization)

library(dplyr)
calafate2 <- calafate2 %>%
  dplyr::filter(Ligth %in% c("High", "Medium"))

calafate2 <- na.omit(calafate2)

calafate2$NPR_aj <- calafate2$NPR+2.955521

```

```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=10, fig.height=8}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
#Eliminar outliers

# Calcular los cuartiles y el IQR
Q1 <- quantile(calafate2$NPR_aj, 0.25, na.rm = TRUE)
Q3 <- quantile(calafate2$NPR_aj, 0.75, na.rm = TRUE)
IQR <- Q3 - Q1

# Definir los límites inferior y superior
lower_bound <- Q1 - 1.5 * IQR
upper_bound <- Q3 + 1.5 * IQR

# Filtrar los datos para eliminar las filas con outliers
calafate2_clean <- calafate2 %>%
  filter(NPR_aj >= lower_bound & NPR_aj <= upper_bound)

# Verifica la cantidad de filas antes y después
# cat("Número de filas antes de eliminar outliers:", nrow(calafate2), "\n")
# cat("Número de filas después de eliminar outliers:", nrow(calafate2_clean), "\n")

```

```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=24, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

library(dplyr)
tabla_calafate2 <- calafate2_clean %>%
  dplyr::group_by(Season, Ligth, Fertilization, Irradiance) %>%
  dplyr::summarise(n=n(),
                   Mean_NPR = mean(NPR),
                   sd_NPR = sd(NPR))

tabla_calafate2 <- calafate2_clean %>%
  dplyr::group_by(Season, Ligth, Fertilization) %>%
  dplyr::summarise(n=n(),
                   Mean_NPR = mean(NPR),
                   sd_NPR = sd(NPR))

tabla_calafate3 <- calafate2_clean %>%
  dplyr::filter(Irradiance == "500") %>%
  dplyr::group_by(Season, Ligth, Fertilization) %>%
  dplyr::summarise(n=n(),
                   Mean_NPR = mean(NPR),
                   sd_NPR = sd(NPR))

```


```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=10, fig.height=8}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

calafate2_clean$Irradiance <- as.factor(calafate2_clean$Irradiance)

library(lme4)
model_irradiance <- glmer(
  NPR_aj ~ Fertilization * Ligth * Season + (1 | Irradiance),
  data = calafate2_clean,
  family = Gamma(link = "log")
)

```

```{r  , echo=FALSE, error=TRUE, fig.align='center', fig.asp=0.4, fig.width=10, fig.height=8}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

# hist(calafate2$NPR, 100)
# 
model_irradiance_ajuste <- as.data.frame(cbind(
  "residuos" = residuals(model_irradiance),
  "predichos" = predict(model_irradiance)))

library(ggplot2)
HV_NRP<-ggplot(model_irradiance_ajuste) +
  aes(predichos, residuos) +
  geom_hline(yintercept = 0, colour="white", size=1) +
  geom_point(colour="white", size=4)+
  theme_classic()+
  labs(y="Residuals", x="Predicted values")+
  theme(legend.position = "bottom", legend.background = element_rect(fill = "gray12"))+
  theme(panel.grid.major.y = element_line(size=0.05, color='white'))+
  theme(panel.grid.major.x = element_blank())+
  theme(text = element_text(size=10, color='white'))+
  theme(axis.text = element_text(color='white'))+
  theme(plot.background = element_rect(fill = "gray12"))+
  theme(panel.background = element_rect(fill = "gray12", color = "white"))
HV_NRP
# 
# QQmodel_irradiance<-ggplot(model_irradiance_ajuste) +
#   aes(sample = residuos) +
#   geom_qq(shape = 1, colour="white") +
#   geom_qq_line(colour="white")+
#   theme_classic()+
#   labs(y="Sample Quantiles", x="Theoretical Quantiles")+
#   theme(legend.position = "bottom", legend.background = element_rect(fill = "gray12"))+
#   theme(panel.grid.major.y = element_line(size=0.05, color='white'))+
#   theme(panel.grid.major.x = element_blank())+
#   theme(text = element_text(size=10, color='white'))+
#   theme(axis.text = element_text(color='white'))+
#   theme(plot.background = element_rect(fill = "gray12"))+
#   theme(panel.background = element_rect(fill = "gray12", color = "white"))
# QQmodel_irradiance
# 
# e<-resid(model_irradiance) # residuos de pearson
# # pre<-predict(mpff) #predichos
# # alfai<-ranef(mpff)$REP$'(Intercept)'
# shapiro.test(e)

# Sin normalidad

```

```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=10, fig.height=8}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

library(car)
Anova(model_irradiance)

```

```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=20, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

#Gráficos de interacción
library(ggplot2)
library(dplyr)

# Resumir los datos para el gráfico de interacción
interaction_data <- calafate2_clean %>%
  dplyr::group_by(Fertilization, Ligth) %>%
  dplyr::summarise(mean_NPR_aj = mean(NPR_aj , na.rm = TRUE))

# Crear el gráfico de interacción
gg_interac <- ggplot(interaction_data, aes(x = Fertilization, y = mean_NPR_aj, color = Ligth, group = Ligth)) +
  geom_line(size=2) +
  geom_point(size=6) +
  labs(title = "Fertilization * Ligth",
       x = "Fertilization",
       y = "NPR [µmolCO2.m-2.s-1]") +
  scale_color_manual(values = c("High" = "#FFFF00", "Medium" = "#4C4C4C")) +
  theme_minimal()+
  theme(panel.grid.major.y = element_line(size = 0.05, color = 'black')) +
  theme(panel.grid.major.x = element_blank()) +
  theme(text = element_text(size = 32, color = 'black')) +
  theme(axis.text = element_text(color = 'black')) +
  theme(legend.position = "bottom")
gg_interac
# # Resumir los datos para el gráfico de interacción
# interaction_data2 <- calafate2_clean %>%
#   dplyr::group_by(Fertilization, Season) %>%
#   dplyr::summarise(mean_NPR_aj = mean(NPR_aj, na.rm = TRUE))
# 
# # Crear el gráfico de interacción
# gg_interac2 <- ggplot(interaction_data2, aes(x = Fertilization, y = mean_NPR_aj, color = Season, group = Season)) +
#   geom_line(size=2) +
#   geom_point(size=6) +
#   labs(title = "Fertilización * Season",
#        x = "Fertilization",
#        y = "NPR [µmolCO2.m-2.s-1]") +
#   scale_color_manual(values = c("1st" = "#6A3D9A", "2nd" = "#FF7F00")) +
#   theme_minimal()+
#   theme(panel.grid.major.y = element_line(size = 0.05, color = 'black')) +
#   theme(panel.grid.major.x = element_blank()) +
#   theme(text = element_text(size = 32, color = 'black')) +
#   theme(axis.text = element_text(color = 'black')) +
#   theme(legend.position = "bottom")
# # 
# gg_interac3 <- ggplot(interaction_data2, aes(x = Season, y = mean_NPR_aj, color = Fertilization, group = Fertilization)) +
#   geom_line(size=2) +
#   geom_point(size=6) +
#   labs(title = "Fertilización * Season",
#        x = "Season",
#        y = "NPR [µmolCO2.m-2.s-1]") +
#   scale_color_manual(values = c("0" = "#E31A1C", "1" = "#FDBF6F", "2" = "#B2DF8A")) +
  # theme_minimal()+
  # theme(panel.grid.major.y = element_line(size = 0.05, color = 'black')) +
  # theme(panel.grid.major.x = element_blank()) +
  # theme(text = element_text(size = 32, color = 'black')) +
  # theme(axis.text = element_text(color = 'black')) +
  # theme(legend.position = "bottom")

```

```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=20, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)



```

```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=20, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)



```

## Efectos simples

```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=20, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

#Como la interaccion fue signifificativa se comparan #Efectos simples
library(emmeans)
library(dplyr)
m1_emm  <- emmeans(model_irradiance, pairwise ~ Fertilization|Ligth|Season, type= "response") 
m1_emm 
m1_simple  <- contrast(m1_emm, method = "revpairwise", simple = "each", adjust = "none") %>%
  summary(infer = TRUE)
m1_simple 

gg_simpef_NRP <- plot(m1_emm, comparisons = TRUE) +
  labs(x = "NPR [µmolCO2.m-2.s-1]", y = "Fertilization") +
  theme_classic() +
  ggtitle("Simple effects") +
  theme(
    plot.title = element_text(hjust = 0.5, size = rel(1), color = "black"),
    legend.position = 'none',
    panel.grid.major.y = element_line(color = "black", size = 1),
    panel.grid.major.x = element_blank(),
    text = element_text(size = 15, color = 'black'),
    axis.text = element_text(color = 'black', size = 20),
    strip.text.y = element_text(angle = 0, size = 20)
  )


gg_simpef_NRP

```

```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=20, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

response_data_irr <- data.frame(m1_emm$emmeans)

response_data_irr$sig_letters <- c("b", "ab", "a", "a", "b", "b", "b", "a", "a", "a", "b", "b")

response_data_irr$response <- response_data_irr$response-2.955521

library(ggplot2)

gg_bar_irr <- ggplot(response_data_irr, aes(x = Season, y = response, fill = Fertilization)) +
  stat_summary(fun = "mean", size = 1, geom = "bar", position = position_dodge(0.6), color = "black", width = 0.6) +
  # geom_errorbar(aes(ymin = response - SE, ymax = response + SE), width = 0.2, position = position_dodge(0.6), color = 'black', size = 1) +
  geom_text(aes(label = sig_letters, y = response  + 0.08), # Ajusta la posición vertical (+ SE)
            position = position_dodge(0.6), vjust = -0.5, size = 8) +
  facet_grid(. ~ Ligth) +
  scale_fill_manual(values = c("0" = "#E31A1C", "1" = "#FDBF6F", "2" = "#B2DF8A")) +
  labs(
    title = "Ligth intensity",
    x = "Growing season",
    y = "NPR [µmol CO2 m-2 s-1]",
    fill = "Fertilization"
  ) +
  theme_classic() +
  theme(plot.title = element_text(size = 32, hjust = 0.5, vjust = 1.5)) +
  theme(panel.grid.major.y = element_line(size = 0.05, color = 'black')) +
  theme(panel.grid.major.x = element_blank()) +
  theme(text = element_text(size = 32, color = 'black')) +
  theme(axis.text = element_text(color = 'black')) +
  theme(legend.position = "bottom") +
  scale_y_continuous(limits = c(0, 2), breaks = seq(0, 2, 0.5))

gg_bar_irr


```

```{r , echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=24, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

# gg_irradiance<-ggplot(tabla_calafate2, aes(x = Irradiance, y = Mean_NPR, color = Fertilization, shape = Season)) +
#   geom_line(size = 1) +  # Líneas para cada combinación de factores
#   geom_point(size = 4) +  # Puntos en cada nivel de Irradiance
#   # geom_errorbar(aes(ymin = Mean_NPR - sd_NPR, ymax = Mean_NPR + sd_NPR), width = 0.1) +  # Barras de error
#   scale_color_manual(values = c("0" = "#E31A1C", "1" = "#FDBF6F", "2" = "#B2DF8A")) +
#   # scale_color_brewer(palette = "Set1") +  # Escala de color para Fertilization
#   scale_shape_manual(values = c(16, 17, 18)) +  # Ajusta los shapes si es necesario
#   labs(
#     title = "",
#     x = "Irradiance [µmol.m-2.s-1]",
#     y = "NPR [µmolCO2 m-2 s-1]",
#     color = "Fertilization",
#     shape = "Season",
#     # linetype = "Season"
#   ) +
#   facet_grid(.~Ligth)+
#   theme_classic() +
#   theme(
#     text = element_text(size = 14),
#     legend.position = "bottom"
#   )+
#   theme(text = element_text(size=26, color='black')) +
#   theme(axis.text = element_text(color='black'))
# 
# gg_irradiance

```

```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=20, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

library(ggplot2)

gg_point_irr <- ggplot(response_data_irr, aes(x = Season, y = response, color = Fertilization, group = Fertilization)) +
  geom_point(position = position_dodge(0.6), size = 6) +
  geom_errorbar(aes(ymin = response - SE, ymax = response + SE), width = 0.2, position = position_dodge(0.6), color = 'black', size = 1) +
  geom_text(aes(label = sig_letters, y = response + SE + 0.2), # Ajusta la posición vertical
            position = position_dodge(0.6), vjust = -0.5, size = 6, color = "black") +
  facet_grid(. ~ Ligth) +
  scale_color_manual(values = c("0" = "#E31A1C", "1" = "#FDBF6F", "2" = "#B2DF8A")) +
  labs(
    title = "Ligth intensity",
    x = "Growing season",
    y = "NPR [µmol CO2 m-2 s-1]",
    fill = "Fertilization"
  ) +
  theme_classic() +
  theme(plot.title = element_text(size = 32, hjust = 0.5, vjust = 1.5)) +
  theme(panel.grid.major.y = element_line(size = 0.05, color = 'black')) +
  theme(panel.grid.major.x = element_blank()) +
  theme(text = element_text(size = 32, color = 'black')) +
  theme(axis.text = element_text(color = 'black')) +
  theme(legend.position = "bottom") +
  scale_y_continuous(limits = c(0, 3), breaks = seq(0, 3, 1))

gg_point_irr


```

# Efectos principales

```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=20, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

# #Como la interaccion fue signifificativa se comparan #Efectos simples
# library(emmeans)
# library(dplyr)
# m1_emm  <- emmeans(model_irradiance, pairwise ~ Fertilization*Ligth*Season, type= "response") 
# m1_emm 
# m1_simple  <- contrast(m1_emm, method = "revpairwise", simple = "each", adjust = "none") %>%
#   summary(infer = TRUE)
# m1_simple 
# 
# gg_simpef_NRP <- plot(m1_emm, comparisons = TRUE) +
#   labs(x = "NPR [µmolCO2.m-2.s-1]", y = "Fertilization") +
#   theme_classic() +
#   ggtitle("Simple effects") +
#   theme(
#     plot.title = element_text(hjust = 0.5, size = rel(1), color = "black"),
#     legend.position = 'none',
#     panel.grid.major.y = element_line(color = "black", size = 1),
#     panel.grid.major.x = element_blank(),
#     text = element_text(size = 15, color = 'black'),
#     axis.text = element_text(color = 'black', size = 20),
#     strip.text.y = element_text(angle = 0, size = 20)
#   )
# 
# 
# gg_simpef_NRP

```

```{r, echo=FALSE, fig.align='center', fig.asp=0.4, fig.width=20, fig.height=16}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)



```

